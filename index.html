<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunRoute – Map, Distance & GPX Export</title>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    :root {
      --panel-bg: rgba(255,255,255,0.92);
      --panel-blur: blur(6px);
      --text: #0f172a;
      --muted: #475569;
      --brand: #0ea5e9;
      --danger: #ef4444;
      --ok: #16a34a;
    }
    html, body, #app { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 1000;
      backdrop-filter: var(--panel-blur);
      background: var(--panel-bg);
      border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,.15);
      color: var(--text);
      padding: 12px; min-width: 280px;
    }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .distance { font-size: 24px; font-weight: 700; }
    .muted { color: var(--muted); font-size: 12px; }
    .btns { display: grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap: 8px; margin-top: 10px; }
    button {
      appearance: none; border: 0; padding: 10px 12px; border-radius: 12px; cursor: pointer;
      background: #e2e8f0; font-weight: 600; transition: transform .06s ease, box-shadow .2s ease; 
      box-shadow: 0 2px 0 rgba(0,0,0,.12);
    }
    button:hover { transform: translateY(-1px); }
    .primary { background: var(--brand); color: white; }
    .danger { background: var(--danger); color: white; }
    .ok { background: var(--ok); color: white; }
    .tiny { font-size: 11px; }
    .legend {
      position: absolute; right: 12px; bottom: 12px; z-index: 1000;
      background: var(--panel-bg); backdrop-filter: var(--panel-blur);
      border-radius: 12px; padding: 8px 10px; color: var(--muted); font-size: 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,.15);
    }
    .toast { position: absolute; left: 50%; transform: translateX(-50%); bottom: 16px; z-index: 1100; 
      background: rgba(17,24,39,.9); color: white; padding: 10px 14px; border-radius: 12px; display:none; }
    .stat { display:flex; align-items:center; gap:8px; }
    .stat div { line-height: 1.05; }
    .stat small { display:block; font-size:11px; color:var(--muted); }
    @media (max-width: 640px) { .panel { min-width: 0; width: calc(100% - 24px);} }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>
    <div class="panel">
      <div class="row">
        <div class="stat">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="#0ea5e9" stroke-width="2" stroke-linecap="round"/></svg>
          <div>
            <div class="distance" id="distance">0.00 km</div>
            <small class="muted" id="segments">0 points • 0 segments</small>
          </div>
        </div>
        <button id="exportBtn" class="primary" title="Download GPX" disabled>Export GPX</button>
      </div>
      <div class="btns">
        <button id="undoBtn" title="Remove last point" disabled>Undo</button>
        <button id="clearBtn" class="danger" title="Clear all" disabled>Clear</button>
        <button id="startHereBtn" class="ok" title="Add first point at my location">Start Here</button>
        <button id="locateBtn" class="ok" title="Go to my location">Locate</button>
        <button id="snapBtn" title="Enable/Disable snap to road">Snap: Off</button>
      </div>
      <div class="tiny muted" style="margin-top:8px">Click the map to add points. Drag points to refine the route. Double‑click to finish a segment.</div>
    </div>
    <div class="legend">Data © OpenStreetMap contributors</div>
    <div class="toast" id="toast"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- <!-- Optional: snap-to-road via OSRM public demo (no key). Rate-limited; for personal use only. -->
  
  <script>
    // ===== Utilities =====
    const fmtKm = (m) => (m/1000).toFixed(2) + ' km';
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000; // meters
      const toRad = d => d * Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function sumDistance(points) {
      let dist = 0;
      for (let i=1;i<points.length;i++) {
        const a = points[i-1], b = points[i];
        dist += haversine(a.lat, a.lng, b.lat, b.lng);
      }
      return dist;
    }
    function toast(msg, ms=1800) {
      const el = document.getElementById('toast');
      el.textContent = msg; el.style.display = 'block';
      setTimeout(()=> el.style.display='none', ms);
    }

    // ===== Map Setup =====
    const map = L.map('map', { zoomControl: true }).setView([ -37.8136, 144.9631 ], 13); // Melbourne default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // Layers & State
    const routeLine = L.polyline([], { color: '#0ea5e9', weight: 5, opacity: 0.9 }).addTo(map);
    const markers = []; // L.Marker list mirroring points
    const state = { points: [], snapping: false };

    function updateUI() {
      routeLine.setLatLngs(state.points);
      const dist = sumDistance(state.points);
      document.getElementById('distance').textContent = fmtKm(dist);
      document.getElementById('segments').textContent = `${state.points.length} points • ${Math.max(0,state.points.length-1)} segments`;
      const hasPts = state.points.length > 0;
      document.getElementById('undoBtn').disabled = !hasPts;
      document.getElementById('clearBtn').disabled = !hasPts;
      document.getElementById('exportBtn').disabled = state.points.length < 2;
    }

    function addPoint(latlng, draggable=true) {
      state.points.push(latlng);
      const mk = L.marker(latlng, { draggable });
      mk.on('drag', (e)=> {
        const idx = markers.indexOf(mk);
        if (idx >= 0) { state.points[idx] = e.target.getLatLng(); updateUI(); }
      });
      mk.on('dragend', ()=> updateUI());
      mk.addTo(map);
      markers.push(mk);
      updateUI();
    }

    function removeLast() {
      if (!state.points.length) return;
      state.points.pop();
      const mk = markers.pop();
      if (mk) mk.remove();
      updateUI();
    }

    function clearAll() {
      state.points.length = 0;
      markers.forEach(m => m.remove());
      markers.length = 0;
      updateUI();
    }

    function exportGPX() {
      if (state.points.length < 2) { toast('Add at least 2 points'); return; }
      const now = new Date();
      const iso = d => d.toISOString();
      // Build GPX XML
      let gpx = '';
      gpx += '<?xml version="1.0" encoding="UTF-8"?>\n';
      gpx += '<gpx version="1.1" creator="RunRoute" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">\n';
      gpx += `  <metadata><time>${iso(now)}</time></metadata>\n`;
      gpx += '  <trk><name>RunRoute Export</name><trkseg>\n';
      for (let i=0;i<state.points.length;i++) {
        const p = state.points[i];
        const t = new Date(now.getTime() + i*1000); // +1s per point
        gpx += `    <trkpt lat="${p.lat}" lon="${p.lng}"><time>${iso(t)}</time></trkpt>\n`;
      }
      gpx += '  </trkseg></trk>\n';
      gpx += '</gpx>';

      const blob = new Blob([gpx], { type: 'application/gpx+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'route.gpx'; a.click();
      URL.revokeObjectURL(url);
      toast('GPX downloaded');
    }

    // Optional: snap to road using OpenRouteService if API key is present and snapping enabled
    async function snapPointsIfEnabled(latlng) {
      if (!state.snapping || state.points.length === 0) return latlng;
      try {
        const last = state.points[state.points.length - 1];
        const url = `https://router.project-osrm.org/route/v1/foot/${last.lng},${last.lat};${latlng.lng},${latlng.lat}?geometries=geojson&overview=full`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Snap failed');
        const data = await res.json();
        const coords = data.routes?.[0]?.geometry?.coordinates || [];
        for (let i = 1; i < coords.length; i++) {
          const [lng, lat] = coords[i];
          addPoint(L.latLng(lat, lng), true);
        }
        return null; // handled by adding snapped points
      } catch (e) {
        console.warn(e);
        toast('Snapping failed – added raw point');
        return latlng;
      }
    }
        return null; // handled by adding snapped points
      } catch (e) {
        console.warn(e);
        toast('Snapping failed – added raw point');
        return latlng;
      }
    }
    return null; // handled by adding snapped points
      } catch (e) {
        console.warn(e);
        toast('Snapping failed – added raw point');
        return latlng;
      }
    }

    // Map interactions
    map.on('click', async (e) => {
      const maybe = await snapPointsIfEnabled(e.latlng);
      if (maybe) addPoint(maybe, true);
    });

    map.on('dblclick', () => toast('Segment finished. Keep clicking to continue.'));

    // Controls
    document.getElementById('undoBtn').addEventListener('click', removeLast);
    document.getElementById('clearBtn').addEventListener('click', clearAll);
    document.getElementById('exportBtn').addEventListener('click', exportGPX);
    document.getElementById('locateBtn').addEventListener('click', () => {
      map.locate({ setView: true, maxZoom: 16 });
    });
    document.getElementById('startHereBtn').addEventListener('click', () => {
      navigator.geolocation.getCurrentPosition((pos)=>{
        const { latitude, longitude } = pos.coords;
        const ll = L.latLng(latitude, longitude);
        addPoint(ll, true);
        map.setView(ll, 16);
        toast('Added starting point at your location');
      }, ()=> toast('Location permission denied'));
    });
    });
    document.getElementById('snapBtn').addEventListener('click', () => {
      state.snapping = !state.snapping;
      document.getElementById('snapBtn').textContent = `Snap: ${state.snapping ? 'On' : 'Off'}`;
      if (state.snapping) {
        toast('Snapping uses OSRM public demo; may be rate-limited');
      }
    });
      }
    });

    // Try geolocation on load
    map.once('load', ()=> map.locate({ setView: true, maxZoom: 15 }));
    // iOS needs explicit call sometimes
    setTimeout(() => map.fire('load'), 300);

    updateUI();
  </script>
</body>
</html>

